<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# Adding IPAM Subnets to Existing Virtual Networks

This example demonstrates how to use the enhanced subnet module to add IPAM subnets to existing IPAM-enabled Virtual Networks. It showcases both IPAM and traditional subnet creation methods using the standalone subnet module.

## ⚠️ **CRITICAL REQUIREMENT: IPAM-Enabled Virtual Networks**

**IPAM subnets can ONLY be created within IPAM-enabled Virtual Networks.**

| VNet Type | IPAM Subnet | Traditional Subnet | Status |
|-----------|-------------|-------------------|--------|
| **IPAM VNet** | IPAM Subnet | ✅ **SUPPORTED** | ✅ **SUPPORTED** |
| **IPAM VNet** | Traditional Subnet | ✅ **SUPPORTED** | Mixed architecture |
| **Traditional VNet** | IPAM Subnet | ❌ **NOT POSSIBLE** | Azure API limitation |

### Why This Requirement Exists:
1. **Azure API Limitation**: IPAM subnet creation requires the parent VNet to be allocated from an IPAM pool
2. **Address Space Coordination**: IPAM needs to manage the entire VNet address space to prevent conflicts
3. **Network Manager Integration**: IPAM functionality depends on Azure Virtual Network Manager managing the VNet

### **Solution for Existing VNets**:
If you need to add IPAM subnets to an existing traditional VNet, you must:
1. **Convert the VNet** to use IPAM pools for its address space, OR
2. **Create a new IPAM-enabled VNet** and migrate resources

## Features Demonstrated

### ✅ **Enhanced Subnet Module Capabilities**
- **IPAM subnet creation** using the standalone subnet module
- **Dynamic IP allocation** from IPAM pools with `ipam_pools` variable
- **Traditional subnet creation** with explicit addressing alongside IPAM subnets
- **Consistent interface** - same module works for both addressing methods
- **All standard features** - NSGs, service endpoints, delegations work with both methods

### ✅ **Module Independence**
- **Standalone operation** - Create individual subnets without full VNet module deployment
- **Individual subnet management** - Add subnets to existing IPAM-enabled VNets
- **Flexible addressing choice** - Select IPAM or traditional per subnet within IPAM VNets
- **Production-ready retry logic** - Same robust error handling as main module

## Architecture

```
Azure Virtual Network (IPAM-Enabled - REQUIRED!)
├── Address Space: 10.0.0.0/16 (dynamically allocated from IPAM pool)
│
├── subnet-ipam-test (Dynamic IPAM Allocation)
│   ├── IP Range: Automatically allocated /24 (256 addresses)
│   ├── Network Security Group: nsg-app
│   └── Service Endpoint: Microsoft.Storage
│
└── subnet-traditional-test (Static Allocation within IPAM VNet)
    ├── IP Range: 10.0.1.0/24 (manually specified within VNet space)
    ├── Network Security Group: nsg-app
    └── Service Endpoint: Microsoft.KeyVault
```

**Note**: This example creates an IPAM-enabled VNet first using the main module, then demonstrates adding both IPAM and traditional subnets to the existing VNet using the enhanced subnet module. In real-world scenarios, you would typically reference an existing IPAM-enabled VNet.

## Use Cases

### **When to Use This Pattern:**
- **Adding subnets to existing IPAM VNets** - Extend existing IPAM-enabled infrastructure
- **Individual subnet management** - Create one subnet at a time without full VNet redeployment
- **Testing subnet module IPAM capabilities** - Validate enhanced subnet module functionality
- **Mixed addressing in existing VNets** - Add both IPAM and traditional subnets as needed
- **Gradual IPAM adoption** - Migrate existing VNet subnets to IPAM incrementally
- **Multi-team scenarios** - Different teams managing different subnets in shared IPAM VNets

### **IPAM vs Traditional Subnet Comparison:**

| Aspect | IPAM Subnet | Traditional Subnet |
|--------|-------------|-------------------|
| **IP Assignment** | Automatic from pool | Manual specification |
| **Conflict Prevention** | Azure manages | Manual planning required |
| **Centralized Governance** | Yes (Network Manager) | No (per-deployment) |
| **Portal Visibility** | IPAM dashboard | "Unallocated" in IPAM views |
| **Flexibility** | Pool-constrained | Exact control |
| **Use Case** | Dynamic/scalable | Specific requirements |

## Key Benefits of Enhanced Subnet Module

1. **✅ Feature Parity**: Same IPAM capabilities as main VNet module
2. **✅ Independence**: Create IPAM subnets without redeploying entire VNet
3. **✅ Consistency**: Identical interface and behavior across modules
4. **✅ Production Ready**: Comprehensive retry logic and error handling
5. **✅ Mixed Architecture**: Support both addressing methods in same deployment

This enhancement enables true modularity - you can now add IPAM subnets to any IPAM-enabled VNet using the same robust, feature-complete subnet module interface.

```hcl
terraform {
  required_version = ">= 1.9.2"

  required_providers {
    azapi = {
      source  = "Azure/azapi"
      version = "~> 2.4"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
  }
}

provider "azurerm" {
  features {
    resource_group {
      prevent_deletion_if_contains_resources = false
    }
  }
}

## Section to provide a random Azure region for the resource group
# This allows us to randomize the region for the resource group.
# IPAM is not yet supported in all regions, therfore commenting out module "regions"
# IPAM NOT supported in these regions:
# "austriaeast",      # Austria East
# "chilecentral",     # Chile Central
# "chinaeast",        # China East
# "chinanorth",       # China North
# "indonesiacentral", # Indonesia Central
# "malaysiawest",     # Malaysia West
# "mexicocentral",    # Mexico Central
# "newzealandnorth",  # New Zealand North
# "spaincentral"      # Spain Central

# module "regions" {
#   source  = "Azure/regions/azurerm"
#   version = "~> 0.3"
# }

locals {
  # Regions where IPAM is officially supported
  # Source: Microsoft Learn documentation for Azure Virtual Network Manager IPAM
  # Excludes regions officially listed as unsupported by Microsoft
  regions = [
    "eastus2",
    "westus2",
    "eastus",
    "westeurope",
    "uksouth",
    "northeurope",
    "centralus",
    "australiaeast",
    "westus",
    "southcentralus",
    "francecentral",
    "southafricanorth",
    "swedencentral",
    "centralindia",
    "eastasia",
    "canadacentral",
    "germanywestcentral",
    "italynorth",
    "norwayeast",
    "polandcentral",
    "switzerlandnorth",
    "uaenorth",
    "brazilsouth",
    "israelcentral",
    "northcentralus",
    "australiacentral",
    "australiacentral2",
    "australiasoutheast",
    "southindia",
    "canadaeast",
    "germanynorth",
    "norwaywest",
    "switzerlandwest",
    "ukwest",
    "uaecentral",
    "brazilsoutheast",
    "mexicocentral",
    "spaincentral",
    "japaneast",
    "koreasouth",
    "koreacentral",
    "newzealandnorth",
    "southeastasia",
    "japanwest",
    "westcentralus",
    "austriaeast"
    # EXCLUDED per Microsoft documentation (IPAM not supported):
    # - "chilecentral", "jioindiawest", "malaysiawest"
    # - "qatarcentral", "southafricawest", "westindia", "westus3"
  ]
}

resource "random_integer" "region_index" {
  max = length(local.regions) - 1
  min = 0
}

module "naming" {
  source  = "Azure/naming/azurerm"
  version = "0.4.2"
}

resource "azurerm_resource_group" "this" {
  location = local.regions[random_integer.region_index.result]
  name     = module.naming.resource_group.name_unique
}

data "azurerm_subscription" "this" {}

# Network Manager and IPAM Pool
resource "azapi_resource" "network_manager" {
  location  = azurerm_resource_group.this.location
  name      = replace(module.naming.resource_group.name_unique, module.naming.resource_group.slug, "avnm")
  parent_id = azurerm_resource_group.this.id
  type      = "Microsoft.Network/networkManagers@2024-07-01"
  body = {
    properties = {
      networkManagerScopeAccesses = []
      networkManagerScopes = {
        subscriptions = [data.azurerm_subscription.this.id]
      }
    }
  }
  retry = {
    interval_seconds     = 10
    max_interval_seconds = 180
    error_message_regex  = ["CannotDeleteResource", "Cannot delete resource while nested resources exist"]
  }
  schema_validation_enabled = false
}



resource "azapi_resource" "ipam_pool" {
  location  = azurerm_resource_group.this.location
  name      = "pool-subnet-test"
  parent_id = azapi_resource.network_manager.id
  type      = "Microsoft.Network/networkManagers/ipamPools@2024-07-01"
  body = {
    properties = {
      addressPrefixes = ["10.0.0.0/16"]
      description     = "IPAM Pool for standalone subnet module testing"
      displayName     = "Subnet Test Pool"
    }
  }
  retry = {
    interval_seconds     = 10
    max_interval_seconds = 180
    error_message_regex  = ["BadRequest", "Ipam pool.*has Azure resources associated"]
  }
  schema_validation_enabled = true
}

# Create VNet with IPAM addressing (REQUIRED for IPAM subnets)
# NOTE: In production, you would typically reference an existing IPAM-enabled VNet
# using data sources rather than creating a new one
module "ipam_vnet" {
  source = "../../"

  location         = azurerm_resource_group.this.location
  parent_id        = azurerm_resource_group.this.id
  enable_telemetry = true
  # VNet gets address space from IPAM pool
  ipam_pools = [{
    id            = azapi_resource.ipam_pool.id
    prefix_length = 16 # /16 VNet (65,536 IP addresses)
  }]
  name = "${module.naming.virtual_network.name_unique}-ipam-test"
  tags = {
    Environment = "test"
    Purpose     = "ipam-subnet-module-demo"
  }
}

resource "azurerm_network_security_group" "app" {
  location            = azurerm_resource_group.this.location
  name                = "${module.naming.network_security_group.name}-app"
  resource_group_name = azurerm_resource_group.this.name

  security_rule {
    access                     = "Allow"
    destination_address_prefix = "*"
    destination_port_ranges    = ["80", "443"]
    direction                  = "Inbound"
    name                       = "AllowHTTP"
    priority                   = 1001
    protocol                   = "Tcp"
    source_address_prefix      = "*"
    source_port_range          = "*"
  }
}

# Test: Create IPAM subnet using the standalone subnet module
module "ipam_subnet" {
  source = "../../modules/subnet"

  name      = "subnet-ipam-test"
  parent_id = module.ipam_vnet.resource_id
  # IPAM allocation
  ipam_pools = [{
    pool_id       = azapi_resource.ipam_pool.id
    prefix_length = 24 # /24 subnet (256 IP addresses)
  }]
  network_security_group = {
    id = azurerm_network_security_group.app.id
  }
  service_endpoints = ["Microsoft.Storage"]
}

# Test: Create traditional subnet using the same module
# Note: Traditional subnets can coexist with IPAM subnets in IPAM-enabled VNets
module "traditional_subnet" {
  source = "../../modules/subnet"

  name             = "subnet-traditional-test"
  parent_id        = module.ipam_vnet.resource_id
  address_prefixes = ["10.0.1.0/24"] # Must be within the IPAM-allocated VNet space
  network_security_group = {
    id = azurerm_network_security_group.app.id
  }
  service_endpoints = ["Microsoft.KeyVault"]
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9.2)

- <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) (~> 2.4)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.0)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

## Resources

The following resources are used by this module:

- [azapi_resource.ipam_pool](https://registry.terraform.io/providers/Azure/azapi/latest/docs/resources/resource) (resource)
- [azapi_resource.network_manager](https://registry.terraform.io/providers/Azure/azapi/latest/docs/resources/resource) (resource)
- [azurerm_network_security_group.app](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) (resource)
- [azurerm_resource_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [random_integer.region_index](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/integer) (resource)
- [azurerm_subscription.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subscription) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

No required inputs.

## Optional Inputs

No optional inputs.

## Outputs

The following outputs are exported:

### <a name="output_ipam_subnet_address_prefixes"></a> [ipam\_subnet\_address\_prefixes](#output\_ipam\_subnet\_address\_prefixes)

Description: The dynamically allocated address prefixes for the IPAM subnet

### <a name="output_ipam_subnet_id"></a> [ipam\_subnet\_id](#output\_ipam\_subnet\_id)

Description: The resource ID of the IPAM subnet

### <a name="output_subnet_module_ipam_comparison"></a> [subnet\_module\_ipam\_comparison](#output\_subnet\_module\_ipam\_comparison)

Description: Comparison of IPAM vs traditional subnet addressing

### <a name="output_traditional_subnet_address_prefixes"></a> [traditional\_subnet\_address\_prefixes](#output\_traditional\_subnet\_address\_prefixes)

Description: The explicitly configured address prefixes for the traditional subnet

### <a name="output_traditional_subnet_id"></a> [traditional\_subnet\_id](#output\_traditional\_subnet\_id)

Description: The resource ID of the traditional subnet

## Modules

The following Modules are called:

### <a name="module_ipam_subnet"></a> [ipam\_subnet](#module\_ipam\_subnet)

Source: ../../modules/subnet

Version:

### <a name="module_ipam_vnet"></a> [ipam\_vnet](#module\_ipam\_vnet)

Source: ../../

Version:

### <a name="module_naming"></a> [naming](#module\_naming)

Source: Azure/naming/azurerm

Version: 0.4.2

### <a name="module_traditional_subnet"></a> [traditional\_subnet](#module\_traditional\_subnet)

Source: ../../modules/subnet

Version:

## Usage

Ensure you have Terraform installed and the Azure CLI authenticated to your Azure subscription.

Navigate to the directory containing this configuration and run:

```
terraform init
terraform plan
terraform apply
```

### Important Notes

- **IPAM Regional Availability**: Ensure your target Azure region supports IPAM functionality
- **Network Manager Permissions**: Your Azure account must have permissions to create Network Managers
- **IPAM Pool Management**: The example creates its own IPAM pool, but in production you'd typically reference existing pools
- **Address Space Planning**: When using traditional subnets in IPAM VNets, ensure they fit within the dynamically allocated space

### Testing the Enhanced Subnet Module

This example validates:
1. **IPAM subnet creation** using the subnet module with existing IPAM-enabled VNets
2. **Traditional subnet creation** within the same existing IPAM VNet
3. **Feature compatibility** - NSGs, service endpoints work with both addressing methods
4. **Module consistency** - Same interface for adding subnets to existing infrastructure

After deployment, verify in the Azure Portal:
- **Network Manager IPAM**: Shows the IPAM subnet allocation
- **Virtual Network**: Displays both subnets with their respective configurations
- **Subnet details**: Confirm IP ranges and associated resources are correct

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoft's privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.

## AVM Versioning Notice

Major version Zero (0.y.z) is for initial development. Anything MAY change at any time. The module SHOULD NOT be considered stable till at least it is major version one (1.0.0) or greater. Changes will always be via new versions being published and no changes will be made to existing published versions. For more details please go to https://semver.org/
<!-- END_TF_DOCS -->