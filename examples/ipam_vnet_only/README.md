<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# IPAM VNet Only Example

This example demonstrates using IPAM for virtual network address space allocation while using traditional addressing methods for subnets.

## Use Case

This pattern is ideal when you want:
- **Centralized VNet address management** through IPAM pools
- **Predictable subnet addressing** using traditional methods
- **Integration with existing subnet management practices**
- **Avoiding IPAM subnet allocation timing complexities**

## Features Demonstrated

### VNet IPAM
- ✅ **VNet address space from IPAM pool** - Dynamic allocation from centralized pool
- ✅ **Flexible pool sizing** - /16 VNet allocated from /12 pool
- ✅ **Integration with existing workflows** - Standard subnet creation patterns

### Traditional Subnet Management
- ✅ **Calculated addressing** - Subnets calculated from IPAM-allocated VNet space
- ✅ **Static addressing** - Manual subnet definition within VNet range
- ✅ **Subnet module integration** - Adding subnets using standalone subnet module
- ✅ **Standard network features** - NSGs, service endpoints, delegations work normally

### Mixed Deployment Patterns
- ✅ **Main module subnets** - Subnets created with VNet
- ✅ **Subnet module extension** - Additional subnets added independently
- ✅ **No timing constraints** - All subnets created in parallel (no delays needed)

## Architecture

```
IPAM Pool (172.16.0.0/12)
│
└── VNet (/16 dynamically allocated, e.g., 172.16.0.0/16)
    ├── subnet-web (172.16.0.0/24) - calculated from VNet
    ├── subnet-app (172.16.1.0/24) - calculated from VNet
    ├── subnet-data (172.16.2.0/25) - calculated from VNet
    ├── subnet-management (172.16.255.240/28) - static addressing
    └── subnet-additional (172.16.2.128/27) - added via subnet module
```

## Deployment Benefits

### Simplified Management
- **No time delays** required between subnet creations
- **Parallel deployment** of all subnets for faster provisioning
- **Predictable addressing** with calculated or static methods

### Enterprise Integration
- **Centralized IP governance** through IPAM pools for VNet allocation
- **Familiar subnet patterns** for operations teams
- **Easy expansion** using subnet module for additional subnets

### Operational Advantages
- **Faster deployments** without sequential subnet creation delays
- **Standard troubleshooting** using traditional networking tools
- **Flexible subnet sizing** without IPAM pool constraints

## Resource Creation Timeline

```
t=0s: All resources created in parallel
├── VNet with IPAM pool allocation
├── subnet-web (calculated)
├── subnet-app (calculated)
├── subnet-data (calculated)
├── subnet-management (static)
└── subnet-additional (via subnet module)
```

## Usage Patterns

### 1. Calculated Subnets (Recommended)
```hcl
subnets = {
  web = {
    name                = "subnet-web"
    calculate_from_vnet = true
    prefix_length       = 24
    subnet_index        = 0
  }
}
```

### 2. Static Subnets (When Address is Known)
```hcl
subnets = {
  management = {
    name             = "subnet-management"
    address_prefixes = ["172.16.255.240/28"]
  }
}
```

### 3. Subnet Module Extension
```hcl
module "additional_subnet" {
  source = "../../modules/subnet"

  virtual_network = {
    resource_id = module.vnet.resource_id
  }
  calculate_from_vnet = true
  prefix_length       = 27
  subnet_index        = 2
}
```

## When to Use This Pattern

### ✅ Ideal For:
- **Hybrid IPAM adoption** - Gradual migration to IPAM
- **Existing subnet management** - Teams comfortable with traditional addressing
- **Performance-critical deployments** - No delays needed for subnet creation
- **Complex subnet requirements** - Custom addressing schemes within IPAM VNets

### ⚠️ Consider Alternatives When:
- **Full IPAM governance** required for subnets
- **Large-scale automated subnet provisioning** needed
- **Complete IP address lifecycle management** is priority

## Expected Outputs

- **VNet with IPAM-allocated address space** (e.g., 172.16.0.0/16)
- **5 subnets total** using different addressing methods:
  - 3 calculated subnets from VNet space
  - 1 static subnet with manual addressing
  - 1 additional subnet via subnet module
- **Fast parallel deployment** of all subnet resources
- **Standard network associations** (NSGs, service endpoints)

## Troubleshooting

### Common Issues
1. **Static Subnet Outside VNet Range**: Ensure static addresses fit within IPAM-allocated VNet space
2. **Calculated Subnet Conflicts**: Check subnet\_index values for overlaps
3. **VNet Address Unknown**: Use data sources or outputs to reference IPAM-allocated ranges

### Best Practices
- Use calculated addressing when possible for automatic conflict avoidance
- Reserve high address ranges (e.g., .240/28) for static management subnets
- Monitor IPAM pool utilization to ensure sufficient space for VNet allocations

This pattern provides the best of both worlds: centralized VNet governance through IPAM with flexible, familiar subnet management practices.

```hcl
terraform {
  required_version = ">= 1.9.2"

  required_providers {
    azapi = {
      source  = "Azure/azapi"
      version = "~> 2.1"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
    time = {
      source  = "hashicorp/time"
      version = "~> 0.13"
    }
  }
}

provider "azurerm" {
  features {
    resource_group {
      prevent_deletion_if_contains_resources = false
    }
  }
}

locals {
  regions = ["eastus2", "westus2", "westeurope"]
}

resource "random_integer" "region_index" {
  max = length(local.regions) - 1
  min = 0
}

module "naming" {
  source  = "Azure/naming/azurerm"
  version = "~> 0.3"
}

resource "azurerm_resource_group" "this" {
  location = local.regions[random_integer.region_index.result]
  name     = module.naming.resource_group.name_unique
}

data "azurerm_subscription" "this" {}

# Create Network Manager for IPAM
resource "azapi_resource" "network_manager" {
  location  = azurerm_resource_group.this.location
  name      = replace(module.naming.resource_group.name_unique, module.naming.resource_group.slug, "avnm")
  parent_id = azurerm_resource_group.this.id
  type      = "Microsoft.Network/networkManagers@2024-07-01"
  body = {
    properties = {
      networkManagerScopeAccesses = []
      networkManagerScopes = {
        subscriptions = [data.azurerm_subscription.this.id]
      }
    }
  }
  schema_validation_enabled = false
}

resource "time_sleep" "wait_30_seconds" {
  create_duration = "30s"

  depends_on = [azapi_resource.network_manager]
}

# IPAM Pool for VNet address space only
resource "azapi_resource" "ipam_pool" {
  location  = azurerm_resource_group.this.location
  name      = "pool-vnet-only"
  parent_id = azapi_resource.network_manager.id
  type      = "Microsoft.Network/networkManagers/ipamPools@2024-07-01"
  body = {
    properties = {
      addressPrefixes = ["172.16.0.0/12"] # Private range for VNet allocation
      description     = "IPAM Pool for VNet address space allocation only"
      displayName     = "VNet Only Pool"
    }
  }
  schema_validation_enabled = false

  depends_on = [time_sleep.wait_30_seconds]
}

# Network Security Groups for traditional subnets
resource "azurerm_network_security_group" "web" {
  location            = azurerm_resource_group.this.location
  name                = "${module.naming.network_security_group.name}-web"
  resource_group_name = azurerm_resource_group.this.name

  security_rule {
    access                     = "Allow"
    destination_address_prefix = "*"
    destination_port_range     = "80"
    direction                  = "Inbound"
    name                       = "AllowHTTP"
    priority                   = 1001
    protocol                   = "Tcp"
    source_address_prefix      = "*"
    source_port_range          = "*"
  }
}

resource "azurerm_network_security_group" "app" {
  location            = azurerm_resource_group.this.location
  name                = "${module.naming.network_security_group.name}-app"
  resource_group_name = azurerm_resource_group.this.name
}

# VNet with IPAM address space allocation but traditional subnet addressing
module "vnet_ipam_traditional_subnets" {
  source = "../../"

  location  = azurerm_resource_group.this.location
  parent_id = azurerm_resource_group.this.id
  # DNS servers configuration
  dns_servers = {
    dns_servers = toset(["1.1.1.1", "8.8.8.8"])
  }
  enable_telemetry = true
  # VNet address space allocated from IPAM pool
  ipam_pools = [{
    id            = azapi_resource.ipam_pool.id
    prefix_length = 16 # /16 VNet from the /12 pool
  }]
  name = "${module.naming.virtual_network.name_unique}-ipam-vnet"
  # Traditional subnets with calculated addressing from VNet space
  subnets = {
    # Calculate subnets from the IPAM-allocated VNet space
    web = {
      name                = "subnet-web"
      calculate_from_vnet = true
      prefix_length       = 24
      subnet_index        = 0 # First /24 in VNet
      network_security_group = {
        id = azurerm_network_security_group.web.id
      }
      service_endpoints = ["Microsoft.Storage", "Microsoft.Sql"]
    }

    app = {
      name                = "subnet-app"
      calculate_from_vnet = true
      prefix_length       = 24
      subnet_index        = 1 # Second /24 in VNet
      network_security_group = {
        id = azurerm_network_security_group.app.id
      }
      service_endpoints = ["Microsoft.Storage"]
    }

    data = {
      name                = "subnet-data"
      calculate_from_vnet = true
      prefix_length       = 25
      subnet_index        = 4 # /25 in VNet space after 2x/24 subnets (172.16.2.0/25)
      network_security_group = {
        id = azurerm_network_security_group.app.id
      }
    }

    # Static addressing within IPAM VNet (requires knowledge of allocated range)
    management = {
      name             = "subnet-management"
      address_prefixes = ["172.16.255.240/28"] # Small management subnet
      network_security_group = {
        id = azurerm_network_security_group.app.id
      }
    }
  }
  tags = {
    Environment = "test"
    Purpose     = "ipam-vnet-only-demo"
    Scenario    = "ipam-vnet-traditional-subnets"
  }
}

# Demonstrate adding subnet to IPAM VNet using subnet module
module "additional_subnet" {
  source = "../../modules/subnet"

  name      = "subnet-additional"
  parent_id = module.vnet_ipam_traditional_subnets.resource_id
  # Use a specific address prefix within the IPAM-allocated VNet space
  address_prefixes = ["172.16.2.128/27"] # /27 in the expected IPAM range
  network_security_group = {
    id = azurerm_network_security_group.app.id
  }
  service_endpoints = ["Microsoft.KeyVault"]

  depends_on = [module.vnet_ipam_traditional_subnets]
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9.2)

- <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) (~> 2.1)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.0)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

- <a name="requirement_time"></a> [time](#requirement\_time) (~> 0.13)

## Resources

The following resources are used by this module:

- [azapi_resource.ipam_pool](https://registry.terraform.io/providers/Azure/azapi/latest/docs/resources/resource) (resource)
- [azapi_resource.network_manager](https://registry.terraform.io/providers/Azure/azapi/latest/docs/resources/resource) (resource)
- [azurerm_network_security_group.app](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) (resource)
- [azurerm_network_security_group.web](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) (resource)
- [azurerm_resource_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [random_integer.region_index](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/integer) (resource)
- [time_sleep.wait_30_seconds](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) (resource)
- [azurerm_subscription.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subscription) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

No required inputs.

## Optional Inputs

No optional inputs.

## Outputs

No outputs.

## Modules

The following Modules are called:

### <a name="module_additional_subnet"></a> [additional\_subnet](#module\_additional\_subnet)

Source: ../../modules/subnet

Version:

### <a name="module_naming"></a> [naming](#module\_naming)

Source: Azure/naming/azurerm

Version: ~> 0.3

### <a name="module_vnet_ipam_traditional_subnets"></a> [vnet\_ipam\_traditional\_subnets](#module\_vnet\_ipam\_traditional\_subnets)

Source: ../../

Version:

## Usage

Ensure you have Terraform installed and the Azure CLI authenticated to your Azure subscription.

Navigate to the directory containing this configuration and run:

```
terraform init
terraform plan
terraform apply
```

## Key Features

- **VNet IPAM allocation** from centralized pools
- **Traditional subnet management** with calculated addressing
- **No timing constraints** - all subnets deploy in parallel
- **Subnet module integration** for additional subnets
- **Hybrid IPAM adoption** strategy

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoft's privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.

## AVM Versioning Notice

Major version Zero (0.y.z) is for initial development. Anything MAY change at any time. The module SHOULD NOT be considered stable till at least it is major version one (1.0.0) or greater. Changes will always be via new versions being published and no changes will be made to existing published versions. For more details please go to https://semver.org/
<!-- END_TF_DOCS -->