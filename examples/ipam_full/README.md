<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# IPAM Full Example

This example demonstrates comprehensive IPAM usage with the Azure Virtual Network module, showcasing all major IPAM capabilities in a single deployment.

## Features Demonstrated

### Virtual Network IPAM
- ✅ **Dual-stack allocation** - IPv4 and IPv6 address spaces from separate IPAM pools
- ✅ **Large address space** - /20 IPv4 pool providing ~4000 IP addresses
- ✅ **Automatic allocation** - VNet address space allocated dynamically from pools

### Subnet IPAM with Conflict Prevention
- ✅ **Time-delayed sequential creation** - Multiple IPAM subnets created with automatic delays
- ✅ **Mixed subnet types** - IPAM subnets alongside traditional static subnets
- ✅ **Variable subnet sizes** - /24, /25, /26, /27 allocations from the same pool
- ✅ **Dual-stack subnets** - IPv4 and IPv6 allocation for the same subnet
- ✅ **Subnet delegation** - IPAM subnet with container instance delegation

### Network Associations
- ✅ **Network Security Groups** - Different NSGs per tier (web, app, data)
- ✅ **Route Tables** - Custom routing for IPAM subnets
- ✅ **Service Endpoints** - Storage, SQL, KeyVault endpoints on IPAM subnets

## Deployment Timeline

The module automatically handles sequential IPAM subnet creation:

```
t=0s:    VNet created with IPAM pools
t=0s:    management subnet (static) created in parallel
t=0s:    web subnet (IPAM) starts
t=30s:   app subnet (IPAM) starts
t=60s:   data subnet (IPAM) starts
t=90s:   services subnet (dual-stack IPAM) starts
t=120s:  containerinstances subnet (IPAM with delegation) starts
```

## Architecture

```
IPAM Pool (10.0.0.0/14)
│
└── VNet (/20 allocated from pool)
    ├── subnet-web-ipam (/24 from pool) + NSG + Route Table
    ├── subnet-app-ipam (/24 from pool) + NSG + Route Table
    ├── subnet-data-ipam (/25 from pool) + NSG
    ├── subnet-management (static /28) + NSG
    ├── subnet-services-dual (/26 IPv4 + /64 IPv6) + Service Endpoints
    └── subnet-aci (/27 from pool) + Container Delegation

IPv6 Pool (fdea:5251:1c0a::/48)
│
└── VNet (/56 allocated from pool)
    └── subnet-services-dual (/64 from pool)
```

## Resource Creation Order

1. **Infrastructure Setup** (parallel)
   - Resource Group
   - Network Manager
   - IPAM Pools (IPv4 + IPv6)
   - Network Security Groups
   - Route Table

2. **VNet Creation**
   - VNet with IPAM pool allocation
   - DNS servers configuration

3. **Subnet Creation** (mixed parallel/sequential)
   - Static management subnet (immediate, parallel)
   - IPAM subnets (sequential with 30s delays)

## Usage

```hcl
# Prerequisites: Ensure IPAM is available in your target region
# Supported regions: East US 2, West US 2, West Europe (and others)

terraform init
terraform plan
terraform apply
```

## Expected Outputs

- **VNet with IPAM-allocated address space** (e.g., 10.0.64.0/20)
- **6 subnets total**:
  - 5 IPAM-allocated subnets of various sizes
  - 1 statically addressed management subnet
- **Proper network associations** (NSGs, route tables, service endpoints)
- **No IP address conflicts** due to automatic sequential creation

## Key Learning Points

1. **Default Timing**: The module uses a default 30-second delay between IPAM subnet allocations
2. **Mixed Addressing**: IPAM and static subnets work together seamlessly
3. **Dual-Stack Support**: Single subnet can have both IPv4 and IPv6 from different pools
4. **Conflict Prevention**: Time delays ensure reliable IPAM deployments at scale
5. **Production Ready**: All standard network features work with IPAM subnets

## Troubleshooting

If you encounter deployment issues:

1. **Check IPAM Region Support**: Ensure your region supports IPAM
2. **Verify Pool Capacity**: Ensure IPAM pool has sufficient address space
3. **Monitor Timing**: Watch for any time-delay related issues in logs
4. **Review Permissions**: Ensure proper Network Manager access

This example serves as the comprehensive test case for the module's IPAM capabilities and demonstrates production-ready patterns for large-scale deployments.

```hcl
terraform {
  required_version = ">= 1.9.2"

  required_providers {
    azapi = {
      source  = "Azure/azapi"
      version = "~> 2.1"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 4.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
    time = {
      source  = "hashicorp/time"
      version = "~> 0.13"
    }
  }
}

provider "azurerm" {
  features {
    resource_group {
      prevent_deletion_if_contains_resources = false
    }
  }
}

# IPAM is available in limited regions
locals {
  regions = ["eastus2", "westus2", "westeurope"]
}

resource "random_integer" "region_index" {
  max = length(local.regions) - 1
  min = 0
}

module "naming" {
  source  = "Azure/naming/azurerm"
  version = "~> 0.3"
}

resource "azurerm_resource_group" "this" {
  location = local.regions[random_integer.region_index.result]
  name     = module.naming.resource_group.name_unique
}

data "azurerm_subscription" "this" {}

# Create Network Manager for IPAM
resource "azapi_resource" "network_manager" {
  location  = azurerm_resource_group.this.location
  name      = replace(module.naming.resource_group.name_unique, module.naming.resource_group.slug, "avnm")
  parent_id = azurerm_resource_group.this.id
  type      = "Microsoft.Network/networkManagers@2024-07-01"
  body = {
    properties = {
      networkManagerScopeAccesses = []
      networkManagerScopes = {
        subscriptions = [data.azurerm_subscription.this.id]
      }
    }
  }
  schema_validation_enabled = false
}

# Allow time for network manager to be ready
resource "time_sleep" "wait_30_seconds" {
  create_duration = "30s"

  depends_on = [azapi_resource.network_manager]
}

# Create IPAM Pools
resource "azapi_resource" "ipam_pool_v4" {
  location  = azurerm_resource_group.this.location
  name      = "pool-ipv4-main"
  parent_id = azapi_resource.network_manager.id
  type      = "Microsoft.Network/networkManagers/ipamPools@2024-07-01"
  body = {
    properties = {
      addressPrefixes = ["10.0.0.0/14"] # Large pool for multiple VNets
      description     = "Main IPv4 IPAM Pool for comprehensive testing"
      displayName     = "IPv4 Main Pool"
    }
  }
  schema_validation_enabled = false

  depends_on = [time_sleep.wait_30_seconds]
}

resource "azapi_resource" "ipam_pool_v6" {
  location  = azurerm_resource_group.this.location
  name      = "pool-ipv6-main"
  parent_id = azapi_resource.network_manager.id
  type      = "Microsoft.Network/networkManagers/ipamPools@2024-07-01"
  body = {
    properties = {
      addressPrefixes = ["fdea:5251:1c0a::/48"]
      description     = "IPv6 IPAM Pool for dual-stack testing"
      displayName     = "IPv6 Main Pool"
    }
  }
  schema_validation_enabled = false

  depends_on = [time_sleep.wait_30_seconds]
}

# Network Security Groups for subnet association
resource "azurerm_network_security_group" "web" {
  location            = azurerm_resource_group.this.location
  name                = "${module.naming.network_security_group.name}-web"
  resource_group_name = azurerm_resource_group.this.name

  security_rule {
    access                     = "Allow"
    destination_address_prefix = "*"
    destination_port_range     = "80"
    direction                  = "Inbound"
    name                       = "AllowHTTP"
    priority                   = 1001
    protocol                   = "Tcp"
    source_address_prefix      = "*"
    source_port_range          = "*"
  }
}

resource "azurerm_network_security_group" "app" {
  location            = azurerm_resource_group.this.location
  name                = "${module.naming.network_security_group.name}-app"
  resource_group_name = azurerm_resource_group.this.name

  security_rule {
    access                     = "Allow"
    destination_address_prefix = "*"
    destination_port_range     = "8080"
    direction                  = "Inbound"
    name                       = "AllowApp"
    priority                   = 1001
    protocol                   = "Tcp"
    source_address_prefix      = "10.0.0.0/16"
    source_port_range          = "*"
  }
}

resource "azurerm_network_security_group" "data" {
  location            = azurerm_resource_group.this.location
  name                = "${module.naming.network_security_group.name}-data"
  resource_group_name = azurerm_resource_group.this.name

  security_rule {
    access                     = "Allow"
    destination_address_prefix = "*"
    destination_port_range     = "5432"
    direction                  = "Inbound"
    name                       = "AllowDatabase"
    priority                   = 1001
    protocol                   = "Tcp"
    source_address_prefix      = "10.0.0.0/16"
    source_port_range          = "*"
  }
}

# Route Table for demonstration
resource "azurerm_route_table" "this" {
  location            = azurerm_resource_group.this.location
  name                = module.naming.route_table.name
  resource_group_name = azurerm_resource_group.this.name

  route {
    address_prefix = "0.0.0.0/0"
    name           = "ToInternet"
    next_hop_type  = "Internet"
  }
}

# Comprehensive IPAM VNet with multiple subnet types
module "vnet_ipam_full" {
  source = "../../"

  location            = azurerm_resource_group.this.location
  resource_group_name = azurerm_resource_group.this.name
  # DNS servers configuration
  # DNS servers configuration
  dns_servers = {
    dns_servers = toset(["1.1.1.1", "8.8.8.8"])
  }
  enable_telemetry = true
  # VNet gets address space from IPAM pool (IPv4 only for now)
  ipam_pools = [
    {
      id            = azapi_resource.ipam_pool_v4.id
      prefix_length = 20 # /20 provides ~4000 IPs for subnets
    }
  ]
  name = "${module.naming.virtual_network.name_unique}-ipam-full"
  subnets = {
    # IPAM-allocated subnets (created sequentially with delays)
    web = {
      name = "subnet-web-ipam"
      ipam_pools = [{
        pool_id       = azapi_resource.ipam_pool_v4.id
        prefix_length = 24 # /24 from the pool
      }]
      network_security_group = {
        id = azurerm_network_security_group.web.id
      }
      route_table = {
        id = azurerm_route_table.this.id
      }
      service_endpoints = ["Microsoft.Storage", "Microsoft.Sql"]
    }

    app = {
      name = "subnet-app-ipam"
      ipam_pools = [{
        pool_id       = azapi_resource.ipam_pool_v4.id
        prefix_length = 24 # /24 from the pool (created after 30s delay)
      }]
      network_security_group = {
        id = azurerm_network_security_group.app.id
      }
      route_table = {
        id = azurerm_route_table.this.id
      }
      service_endpoints = ["Microsoft.Storage"]
    }

    data = {
      name = "subnet-data-ipam"
      ipam_pools = [{
        pool_id       = azapi_resource.ipam_pool_v4.id
        prefix_length = 25 # /25 from the pool (created after 60s delay)
      }]
      network_security_group = {
        id = azurerm_network_security_group.data.id
      }
      service_endpoints = ["Microsoft.Storage", "Microsoft.Sql"]
    }

    # Mixed: Static subnet alongside IPAM subnets
    management = {
      name             = "subnet-management"
      address_prefixes = ["10.0.15.0/28"] # Small static management subnet
      network_security_group = {
        id = azurerm_network_security_group.app.id
      }
    }

    # IPv4 IPAM subnet (services)
    services = {
      name = "subnet-services"
      ipam_pools = [{
        pool_id       = azapi_resource.ipam_pool_v4.id
        prefix_length = 26 # /26 IPv4 (created after 90s delay)
      }]
      service_endpoints = ["Microsoft.KeyVault", "Microsoft.Storage"]
    }

    # Subnet with delegation
    containerinstances = {
      name = "subnet-aci"
      ipam_pools = [{
        pool_id       = azapi_resource.ipam_pool_v4.id
        prefix_length = 27 # /27 for container instances (created after 120s delay)
      }]
      delegations = [{
        name = "containerinstance_delegation"
        service_delegation = {
          name = "Microsoft.ContainerInstance/containerGroups"
        }
      }]
    }
  }
  tags = {
    Environment = "test"
    Purpose     = "ipam-comprehensive-testing"
    Scenario    = "full-ipam-deployment"
  }
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.9.2)

- <a name="requirement_azapi"></a> [azapi](#requirement\_azapi) (~> 2.1)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (~> 4.0)

- <a name="requirement_random"></a> [random](#requirement\_random) (~> 3.5)

- <a name="requirement_time"></a> [time](#requirement\_time) (~> 0.13)

## Resources

The following resources are used by this module:

- [azapi_resource.ipam_pool_v4](https://registry.terraform.io/providers/Azure/azapi/latest/docs/resources/resource) (resource)
- [azapi_resource.ipam_pool_v6](https://registry.terraform.io/providers/Azure/azapi/latest/docs/resources/resource) (resource)
- [azapi_resource.network_manager](https://registry.terraform.io/providers/Azure/azapi/latest/docs/resources/resource) (resource)
- [azurerm_network_security_group.app](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) (resource)
- [azurerm_network_security_group.data](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) (resource)
- [azurerm_network_security_group.web](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) (resource)
- [azurerm_resource_group.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [azurerm_route_table.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/route_table) (resource)
- [random_integer.region_index](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/integer) (resource)
- [time_sleep.wait_30_seconds](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) (resource)
- [azurerm_subscription.this](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subscription) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

No required inputs.

## Optional Inputs

No optional inputs.

## Outputs

No outputs.

## Modules

The following Modules are called:

### <a name="module_naming"></a> [naming](#module\_naming)

Source: Azure/naming/azurerm

Version: ~> 0.3

### <a name="module_vnet_ipam_full"></a> [vnet\_ipam\_full](#module\_vnet\_ipam\_full)

Source: ../../

Version:

## Usage

Ensure you have Terraform installed and the Azure CLI authenticated to your Azure subscription.

Navigate to the directory containing this configuration and run:

```
terraform init
terraform plan
terraform apply
```

## Key Features

- **Comprehensive IPAM deployment** with VNet and subnet allocation
- **Dual-stack support** for IPv4 and IPv6 from separate pools
- **Time-delayed sequential creation** prevents allocation conflicts
- **Mixed addressing** - IPAM and static subnets coexist
- **Production-ready** with NSGs, route tables, and service endpoints

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoft's privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.

## AVM Versioning Notice

Major version Zero (0.y.z) is for initial development. Anything MAY change at any time. The module SHOULD NOT be considered stable till at least it is major version one (1.0.0) or greater. Changes will always be via new versions being published and no changes will be made to existing published versions. For more details please go to https://semver.org/
<!-- END_TF_DOCS -->